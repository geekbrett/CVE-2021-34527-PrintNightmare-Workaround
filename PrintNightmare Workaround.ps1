# Description
# This simple PowerShell script is in response to the "PrintNightmare" vulnerability. This was designed to give a end user the ability to stop and disable the "Print Spooler" service on their computer while awaiting a fix from Microsoft.
# When the service is not running and a user runs the script, it gives them the option to re-enable the service for ten minutes while they print the jobs they need to, after the time has elapsed, it stops and disables the service. It also gives them the option to turn on the service until it is turned off again.

# Elevate to Administrator
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator"))  
{  
  $arguments = "& '" +$myinvocation.mycommand.definition + "'"
  Start-Process powershell -Verb runAs -ArgumentList $arguments
  Break
}

Write-Host "                                                                              " -ForegroundColor Black -BackgroundColor White
Write-Host "   'PrintNightmare' Vulnerability Temporary Fix/Workaround - CVE-2021-34527   " -ForegroundColor Black -BackgroundColor White
Write-Host "                                                                              " -ForegroundColor Black -BackgroundColor White
Write-Host ""

# Disable Print Spooler inbound remote printing
if (!(Test-Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers')){
	Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
	Write-Host "          Print Spooler is accepting inbound requests, disabling now.         " -ForegroundColor White -BackgroundColor Red
	Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
	New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT" -Name Printers -Force
	New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers" -Name "RegisterSpoolerRemoteRpcEndPoint" -value 2 -Force
} else {
	$value = Get-ItemPropertyValue -path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers' -Name 'RegisterSpoolerRemoteRpcEndPoint'
	if ($value -ne 2){
		Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
		Write-Host "          Print Spooler is accepting inbound requests, disabling now.         " -ForegroundColor White -BackgroundColor Red
		Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
		Set-Itemproperty -path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers' -Name 'RegisterSpoolerRemoteRpcEndPoint' -value '2'
	}
}
Write-Host ""
$arrService = Get-Service -Name spooler
if ($arrService.Status -eq 'Running'){
	Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
	Write-Host "       The print spooler service is running, would you like to stop it?       " -ForegroundColor White -BackgroundColor Red
	Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
	$input = Read-Host -Prompt 'Press Y for yes, or N for no, then hit enter.'
	Write-Host ""
	if ($input -eq 'Y'){
		Write-Host "Stopping and disabling the service now."
		Set-Service -Name Spooler -StartupType Disabled
		Stop-Service -Name Spooler -Force
		Write-Host ""
		Read-Host -Prompt "Complete. Press enter to exit."
	} else {
		Read-Host -Prompt "Doing nothing. Press enter to exit."
	}
} else {
	Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Green
	Write-Host "      The print spooler service is stopped, would you like to start it?       " -ForegroundColor White -BackgroundColor Green
	Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Green
	$input = Read-Host -Prompt 'Press T, for temporary. Press Y for permenant. Press N for no. After you have made a selection hit enter.'
	Write-Host ""
	if ($input -eq 'Y'){
		Write-Host ""
		Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
		Write-Host "                    Enabling and starting the service now.                    " -ForegroundColor White -BackgroundColor Red
		Write-Host "                                                                              " -ForegroundColor White -BackgroundColor Red
		Set-Service -Name Spooler -StartupType Automatic
		Start-Service -Name Spooler
		Write-Host ""
		Read-Host -Prompt "Complete. Press enter to exit."
	} elseif ($input -eq 'T') {
		Write-Host "Temporarily enabling and starting the service for 10 minutes"
		Set-Service -Name Spooler -StartupType Automatic
		Start-Service -Name Spooler
		Write-Host ""
		Start-Sleep -s 600 # 600=10 minutes
		Set-Service -Name Spooler -StartupType Disabled
		Stop-Service -Name Spooler -Force
		Write-Host ""
		Read-Host -Prompt "Time's up, disabling and stopping Print Spooler service again. Press enter to exit."
	} else {
		Read-Host -Prompt "Doing nothing. Press enter to exit."
	}
}
# Description
# This simple PowerShell script is in response to the "PrintNightmare" vulnerability. This was designed to give a end user the ability to stop and disable the "Print Spooler" service on their computer while awaiting a fix from Microsoft.
# When the service is not running and a user runs the script, it gives them the option to re-enable the service for ten minutes while they print the jobs they need to, after the time has elapsed, it stops and disables the service. It also gives them the option to turn on the service until it is turned off again.

# Elevate to Administrator
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator"))  
{  
  $arguments = "& '" +$myinvocation.mycommand.definition + "'"
  Start-Process powershell -Verb runAs -ArgumentList $arguments
  Break
}

Write-Host "'PrintNightmare' Vulnerability Temporary Fix/Workaround - CVE-2021-34527"
Write-Host ""
$arrService = Get-Service -Name spooler
if ($arrService.Status -eq 'Running'){
	Write-Host "The print spooler service is running, would you like to stop it?"
	$input = Read-Host -Prompt 'Press Y for yes, or N for no, then hit enter.'
	Write-Host ""
	if ($input -eq 'Y'){
		Write-Host "Stopping and disabling the service now."
		Set-Service -Name Spooler -StartupType Disabled
		Stop-Service -Name Spooler -Force
		Write-Host ""
		Read-Host -Prompt "Complete. Press enter to exit."
	} else {
		Read-Host -Prompt "Doing nothing. Press enter to exit."
	}
} else {
	Write-Host "The print spooler service is stopped, would you like to start it?"
	$input = Read-Host -Prompt 'Press T, for temporary. Press Y for permenant. Press N for no. After you have made a selection hit enter.'
	Write-Host ""
	if ($input -eq 'Y'){
		Write-Host "Enabling and starting the service now."
		Set-Service -Name Spooler -StartupType Automatic
		Start-Service -Name Spooler
		Write-Host ""
		Read-Host -Prompt "Complete. Press enter to exit."
	} elseif ($input -eq 'T') {
		Write-Host "Temporarily enabling and starting the service for 10 minutes"
		Set-Service -Name Spooler -StartupType Automatic
		Start-Service -Name Spooler
		Write-Host ""
		Start-Sleep -s 600 # 10 minutes
		Set-Service -Name Spooler -StartupType Disabled
		Stop-Service -Name Spooler -Force
		Write-Host ""
		Read-Host -Prompt "Time's up, disabling and stopping Print Spooler service again. Press enter to exit."
	} else {
		Read-Host -Prompt "Doing nothing. Press enter to exit."
	}
}